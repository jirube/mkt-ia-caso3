<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marketing AI - Colaborativo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .nav-link.active { background-color: #0d6efd !important; color: white !important; }
        .gallery-img { height: 180px; object-fit: cover; width: 100%; cursor: pointer; }
        .comment-box { max-height: 300px; overflow-y: auto; background: #f1f3f5; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body class="bg-light d-flex flex-column min-vh-100">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">üöÄ Marketing AI Team</a>
        <div class="d-flex text-white align-items-center">
            <span class="me-3">{{ user.username }} ({{ user.role }})</span>
            <a href="/logout" class="btn btn-outline-danger btn-sm">Salir</a>
        </div>
    </div>
</nav>

<div class="container mt-4 flex-grow-1">
    <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pills-img">üé® Im√°genes</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-text">üìù Texto Avanzado</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-collab" onclick="loadCollab()">ü§ù Colaboraci√≥n</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-gallery" onclick="loadGallery()">üñºÔ∏è Galer√≠a</button></li>
    </ul>

    <div class="tab-content" id="pills-tabContent">
        
        <div class="tab-pane fade show active" id="pills-img">
            <div class="card shadow-sm p-3">
                <h5>Generador Visual</h5>
                <div class="row">
                    <div class="col-md-9"><input type="text" id="imgPrompt" class="form-control" placeholder="Describe la imagen..."></div>
                    <div class="col-md-3">
                        <select id="imgStyle" class="form-select">
                            <option value="photographic">Fotogr√°fico</option>
                            <option value="cinematic">Cinem√°tico</option>
                            <option value="anime">Anime</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary mt-2 w-100" onclick="generateImage()">‚ú® Generar</button>
                <div id="imgLoading" class="text-center mt-2" style="display:none;"><div class="spinner-border text-primary"></div></div>
                <div class="mt-3 text-center"><img id="imgResult" src="" class="img-fluid rounded shadow" style="display:none; max-height: 400px;"></div>
            </div>
        </div>

        <div class="tab-pane fade" id="pills-text">
            <div class="card shadow-sm p-3">
                <h5>Editor de Texto Inteligente</h5>
                <textarea id="txtInput" class="form-control mb-3" rows="4" placeholder="Pega tu texto aqu√≠..."></textarea>
                <div class="input-group mb-3">
                    <select id="txtAction" class="form-select">
                        <option value="Resumir">Resumir</option>
                        <option value="Traducir al Ingl√©s">Traducir al Ingl√©s</option>
                        <option value="Corregir Estilo">Corregir Estilo</option>
                        <option value="Tono Marketing">Tono Marketing</option>
                    </select>
                    <input type="text" id="txtCustom" class="form-control" placeholder="Instrucci√≥n extra...">
                </div>
                <button class="btn btn-success w-100" onclick="editText()">üñäÔ∏è Ejecutar Acci√≥n</button>
                <div id="txtLoading" class="text-center mt-2" style="display:none;"><div class="spinner-border text-success"></div></div>
                <div class="mt-3 p-3 bg-white border rounded"><p id="txtResult" class="mt-2 text-muted">Aqu√≠ saldr√° el resultado...</p></div>
            </div>
        </div>

        <div class="tab-pane fade" id="pills-collab">
            <div class="d-flex justify-content-between align-items-center mb-3"><h5>Tablero de Equipo</h5><button class="btn btn-sm btn-outline-secondary" onclick="loadCollab()">üîÑ Refrescar</button></div>
            <div class="row" id="collabContainer"></div>
        </div>
        
        <div class="tab-pane fade" id="pills-gallery">
            <div class="d-flex justify-content-between align-items-center mb-3"><h5>Mis Im√°genes</h5><button class="btn btn-sm btn-outline-secondary" onclick="loadGallery()">üîÑ Refrescar</button></div>
            <div class="row" id="galleryContainer"></div>
        </div>
    </div>
</div>

<footer class="bg-white border-top mt-5 py-3 text-center">
    <div class="container">
        <small class="text-muted">¬© 2026 Marketing AI Project.</small>
        <button class="btn btn-link btn-sm text-decoration-none" data-bs-toggle="modal" data-bs-target="#ethicsModal">‚öñÔ∏è Pol√≠ticas de Uso √âtico</button>
    </div>
</footer>

<div class="modal fade" id="ethicsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-light"><h5 class="modal-title">‚öñÔ∏è √âtica y Seguridad</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <h6>1. Seguridad</h6><p class="small text-muted">Datos cifrados (SHA-256) y transmisi√≥n segura.</p>
                <h6>2. Moderaci√≥n</h6><p class="small text-muted text-danger">Filtros activos contra violencia y odio.</p>
                <h6>3. Derechos</h6><p class="small text-muted">El usuario es responsable del uso del contenido generado.</p>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Entendido</button></div>
        </div>
    </div>
</div>

<div class="modal fade" id="commentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">üí¨ Comentarios</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <input type="hidden" id="currentContentId">
                <div id="commentsList" class="comment-box mb-3"></div>
                <div class="input-group"><input type="text" id="newComment" class="form-control" placeholder="Escribir..."><button class="btn btn-primary" onclick="postComment()">Enviar</button></div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- L√ìGICA DE IMAGEN ---
    async function generateImage() {
        const prompt = document.getElementById('imgPrompt').value;
        const style = document.getElementById('imgStyle').value;
        if(!prompt) return alert("Escribe un prompt");
        document.getElementById('imgLoading').style.display = 'block';
        try {
            const res = await fetch('/api/generate-image', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({prompt, style})
            });
            const data = await res.json();
            if(data.error) alert("‚õî " + data.error);
            else {
                document.getElementById('imgResult').src = data.image_url;
                document.getElementById('imgResult').style.display = 'block';
            }
        } catch(e) { alert("Error de conexi√≥n"); } 
        finally { document.getElementById('imgLoading').style.display = 'none'; }
    }

    // --- L√ìGICA DE TEXTO ---
    async function editText() {
        const text = document.getElementById('txtInput').value;
        const action_type = document.getElementById('txtAction').value;
        const instruction = document.getElementById('txtCustom').value;
        if(!text) return alert("Escribe texto");
        document.getElementById('txtLoading').style.display = 'block';
        try {
            const res = await fetch('/api/edit-text', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({text, action_type, instruction})
            });
            const data = await res.json();
            if(data.error) alert("‚õî " + data.error);
            else document.getElementById('txtResult').innerText = data.result;
        } catch(e) { alert("Error"); }
        finally { document.getElementById('txtLoading').style.display = 'none'; }
    }

    // --- COLABORACI√ìN ---
    async function loadCollab() {
        const c = document.getElementById('collabContainer');
        c.innerHTML = '<div class="text-center w-100">Cargando...</div>';
        try {
            const res = await fetch('/api/history-full');
            const data = await res.json();
            c.innerHTML = '';
            if(data.length===0) { c.innerHTML='<div class="alert alert-info">Sin datos a√∫n.</div>'; return; }
            
            data.forEach(i => {
                let disp = i.action === 'image_gen' 
                    ? `<img src="${i.url}" class="card-img-top gallery-img">` 
                    : `<div class="p-3 bg-light text-muted small" style="height:180px; overflow:hidden;">${i.result}</div>`;
                
                c.innerHTML += `
                <div class="col-md-4 mb-4">
                    <div class="card h-100 shadow-sm">
                        ${disp}
                        <div class="card-body">
                            <h6 class="badge bg-${i.action === 'image_gen' ? 'primary' : 'success'}">${i.action}</h6>
                            <p class="small text-muted mb-2">${i.user} | ${i.date}</p>
                            <button class="btn btn-outline-dark btn-sm w-100" onclick="openComments(${i.id})">üí¨ Comentarios (${i.comments})</button>
                        </div>
                    </div>
                </div>`;
            });
        } catch(e) { c.innerHTML = '<div class="alert alert-danger">Error cargando datos.</div>'; }
    }

    // --- GALER√çA ---
    async function loadGallery() {
        const c = document.getElementById('galleryContainer');
        c.innerHTML = '<div class="text-center w-100">Cargando...</div>';
        try {
            const res = await fetch('/api/my-images');
            const data = await res.json();
            c.innerHTML = '';
            if(data.length===0) { c.innerHTML='<div class="alert alert-info">No hay im√°genes.</div>'; return; }

            data.forEach(i => {
                c.innerHTML += `
                <div class="col-md-3 mb-3">
                    <div class="card h-100">
                        <img src="${i.url}" class="card-img-top gallery-img">
                        <div class="card-body p-2 text-center">
                            <small class="d-block text-truncate mb-2">${i.prompt}</small>
                            <a href="${i.url}" download class="btn btn-sm btn-primary w-100">Descargar</a>
                        </div>
                    </div>
                </div>`;
            });
        } catch(e) { c.innerHTML='Error'; }
    }

    // --- COMENTARIOS ---
    function openComments(id) {
        document.getElementById('currentContentId').value = id;
        new bootstrap.Modal(document.getElementById('commentModal')).show();
        fetchComments(id);
    }

    async function fetchComments(id) {
        const l = document.getElementById('commentsList');
        l.innerHTML = 'Cargando...';
        const res = await fetch(`/api/get-comments/${id}`);
        const data = await res.json();
        l.innerHTML = '';
        if(data.length === 0) l.innerHTML = '<p class="text-muted text-center small">S√© el primero en comentar.</p>';
        data.forEach(c => l.innerHTML += `<div class="border-bottom mb-2 pb-1"><strong>${c.user}</strong> <span class="text-muted small">${c.date}</span><br>${c.text}</div>`);
    }

    async function postComment() {
        const id = document.getElementById('currentContentId').value;
        const text = document.getElementById('newComment').value;
        if(!text) return;
        
        await fetch('/api/add-comment', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({content_id: id, text})
        });
        document.getElementById('newComment').value = '';
        fetchComments(id);
        loadCollab(); 
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
